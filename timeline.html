<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONOS: CLEAN_VIEW</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        :root {
            --bat-cyan: #00ffff;
            --bat-blue: #0055ff;
            --bat-dark: #000205;
        }

        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: var(--bat-dark); 
            font-family: 'Share Tech Mono', monospace;
            color: var(--bat-cyan);
            user-select: none;
        }

        #canvas-container {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 1;
        }

        .scanlines {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.1) 50%,
                rgba(0,0,0,0.1)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 20;
            opacity: 0.15;
        }

        #ui-layer {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 40px 60px; 
            box-sizing: border-box; 
        }

        .header {
            display: flex;
            justify-content: flex-end;
            width: 100%;
        }

        .brand-box {
            border: 1px solid var(--bat-cyan);
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.85);
            white-space: nowrap; 
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.1);
        }

        .brand {
            font-size: 1.2rem;
            font-weight: bold;
            letter-spacing: 2px;
            color: #fff;
        }

        .dashboard {
            width: 100%;
            display: flex;
            justify-content: flex-end; 
            align-items: flex-end;
            padding-bottom: 20px; 
        }

        #info-panel {
            background: rgba(0, 2, 5, 0.95);
            border: 1px solid var(--bat-cyan);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.15);
            width: 450px;
            padding: 30px;
            transform: translateX(50px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            clip-path: polygon(20px 0, 100% 0, 100% 100%, 0 100%, 0 20px);
            backdrop-filter: blur(5px);
        }

        #info-panel.active {
            transform: translateX(0);
            opacity: 1;
        }

        .monarch-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 2.8rem;
            color: #fff;
            margin: 0;
            text-transform: uppercase;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .monarch-meta {
            color: var(--bat-cyan);
            font-size: 1.1rem;
            margin: 5px 0 15px 0;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .monarch-desc {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #b0c0d0;
        }

        #progress-line-bg {
            position: fixed;
            bottom: 0; left: 0;
            width: 100%; height: 6px;
            background: #00111f;
            z-index: 30;
        }
        #progress-line-fill {
            height: 100%;
            width: 0%; 
            background: var(--bat-cyan);
            box-shadow: 0 0 15px var(--bat-cyan);
            transition: width 0.1s linear;
        }

        #loading {
            position: fixed;
            top:0; left:0; width:100%; height:100%;
            background: #000;
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--bat-cyan);
            font-size: 1.2rem;
            letter-spacing: 3px;
            transition: opacity 0.8s ease;
        }

        .brand-stack-fixed {
            position: fixed;
            top: 40px;
            left: 60px;
            z-index: 40;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            pointer-events: auto;
        }

        .back-btn {
            background: rgba(0, 0, 0, 0.85);
            color: var(--bat-cyan);
            border: 1px solid var(--bat-cyan);
            padding: 10px 16px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            letter-spacing: 2px;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.2);
        }

        .back-btn:hover {
            background: rgba(0, 255, 255, 0.1);
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="loading">
        <div>SYSTEM STARTUP</div>
        <div style="font-size: 0.8rem; margin-top:10px; opacity:0.7;">INITIALIZING TIMELINE: 2022</div>
    </div>

    <div class="brand-stack-fixed">
        <div class="brand-box"><div class="brand">WIC Robotics Timeline</div></div>
        <button class="back-btn" type="button" onclick="window.history.back()">Back</button>
    </div>

    <div class="scanlines"></div>

    <div id="ui-layer">
        <div class="header">
            <div class="brand-box"><div class="brand" id="date-display">2022</div></div>
        </div>

        <div class="dashboard">
            <div id="info-panel">
                <h1 class="monarch-title" id="ui-name">Name</h1>
                <div class="monarch-meta" id="ui-meta">Date</div>
                <div class="monarch-desc" id="ui-desc">Description</div>
            </div>
        </div>
    </div>

    <div id="progress-line-bg">
        <div id="progress-line-fill"></div>
    </div>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // Styling for the floating cards text
        const cardAppearance = {
            titleColor: '#ffffff',
            titleFont: '800 90px Rajdhani',
            titleFontLong: '800 60px Rajdhani',
            titleY: 240,
            dateColor: '#00ffff',
            dateFont: '500 50px Share Tech Mono',
            dateY: 380,
            borderColor: '#00ffff'
        };

        const timelineEvents = [
            { name: "CRC Competition", date: "FIN", desc: "Project Completed. End of line.", isCenter: true },
            { name: "Ready… Set…", date: "FEBRUARY-CURRENT", desc: `-Solved advanced programming problems beyond expectations, demonstrating significant progress from knowing nothing four months earlier.` },
            { name: "Improvement", date: "JANUARY", desc: `-Built on students’ improvement, strong problem-solving skills, and full Python knowledge, we explored deeper topics such as binary trees and recursion.` },
            { name: "Comp Practice", date: "NOVEMBER-DECEMBER", desc: `-Trained students for the upcoming competition through preliminaries. \n-Conducted a full-day simulation on a PED day using past TAKTIK, bringing preparations back on track.` },
            { name: "Roadblock", date: "November", desc: `-Students struggled to learn because they were only asked to copy code, limiting their ability to apply it creatively, as seen in the first preliminary.` },
            { name: "Complexification (Arrays)", date: "OCTOBER", desc: `-Commencing more and more complex elements of python to teach to junior students such as; arrays, lists, dictionaries, etc.\n-Encountering harder concepts and increased difficulty for students.` },
            { name: "Foundation", date: "AUGUST-SEPTEMBER", desc: `-Creating python curriculum and google classroom.\n-Teaching and initiating the juniors members to the basics of python(input, print, if, else, elif, for loops).` },
            { name: "Programming Team", date: "BEGINNING", desc: "This marks the beginning of the Programming Team's progress", isCenter: true },
            { name: "Claw", date: "January-February", desc: `-CAD the sprockets for the chain-pulley system\n-Calculate increased moment of inertia and build lift` },
            { name: "Electronics", date: "January", desc: `-Optimize the positioning of the electronics, on the main frame of the robot, while ensuring reliability, maintainability with clean cable managing` },
            { name: "Drive", date: "DECEMBER-JANUARY", desc: `-Build the drive system\n-Build bracing and connected bearings/gears\n-Changed from tread drive to RWD independent drive sys.` },
            { name: "Conveyors", date: "NOVEMBER-DECEMBER", desc: `-Build / Design the conveyor systems distinct to each GP\n-CAD the chain, dividers and sprockets for the conveyor\n-CAD the bearing mount and bracket for the conveyor` },
            { name: "Frame", date: "OCTOBER", desc: `-Build the frame of the robot\n-Finalize dimensions and main chassis bracing` },
            { name: "Robot Team", date: "BEGINNING", desc: "This marks the beginning of the Robot Team's progress", isCenter: true },
            { name: "Finalizing Edits", date: "JANUARY", desc: `-Finishing the last scenes \n-Editing and finishing the entire video` },
            { name: "Filming", date: "NOVEMBER-DECEMBER", desc: `-Action scenes being filmed; more time-consuming\n-Staying after school more often to film\n-Editing scenes as we go, looking into editing ideas, special effects, etc.` },
            { name: "Preparation", date: "OCTOBER-NOVEMBER", desc: `-Script completed \n-Start brainstorming where each scene will be filmed and how it will be filmed\n-Finalizing who will be acting in the video and who they will be\n-Buying costumes for the actors \n-Beginning the filming process` },
            { name: "Brainstorming", date: "SEPTEMBER", desc: `-Brainstorming\n-Writing the script\n-Actor recruitment` },
            { name: "Video Team", date: "BEGINNING", desc: "This marks the beginning of the Video Team's progress", isCenter: true },
            { name: "Finalization", date: "JANUARY-FEBRUARY", desc: `-Finalizing walls and car\n-Tables being built \n-Finalizing pinball machine code, 3D printed objects for kiosk, etc. \n-Physically laying out the kiosk on the stage to see how it looks` },
            { name: "Action", date: "NOVEMBER-DECEMBER", desc: `-Worked on the car\n-Walls being sketched and painted` },
            { name: "Preparation", date: "OCTOBER-NOVEMBER", desc: `-Preparing walls. Wanted to redo the walls entirely in comparison to last year \n-Started designing and building the car: car frame` },
            { name: "Brainstorming", date: "FEBRUARY-MAY AND SEPTEMBER", desc: `-Discussed organizing kiosk layout; walls and wow factors. and ways to make construction achievable while also keeping a good visual factor\n-Construction of pinball machine \n-Training session for juniors \n-Deciding on construction of batmobile \n-Ordering supplies` },
            { name: "Kiosk Team", date: "BEGINNING", desc: "This marks the beginning of the Kiosk team's progress", isCenter: true }
        ];

        // World physics and scroll settings
        const worldSettings = {
            wheelRadius: 120,    
            roadWidth: 46,       
            scrollSpeed: 0.0008, 
        };

        const anglePerCard = 20 * (Math.PI / 180);
        const maxScrollLimit = ((timelineEvents.length - 1) * 20) * (Math.PI / 180);

        // Start at the end (Charles III equivalent) + a little buffer
        const startPosition = maxScrollLimit + .25;

        // Track the user's scroll position and load state
        const viewerState = {
            currentScroll: startPosition, 
            targetScroll: startPosition,
            activeCardIndex: -1,
            maxScroll: maxScrollLimit,
            isLoaded: false
        };

        const canvasWrapper = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000205);
        scene.fog = new THREE.Fog(0x000205, 10, 95); 

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 4.0, 0); 
        camera.lookAt(0, -1.5, -50);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        canvasWrapper.appendChild(renderer.domElement);

        // Hide the top of the wheel so cards don't float in the sky
        const skyMaskGeo = new THREE.PlaneGeometry(200, 60);
        const skyMaskMat = new THREE.MeshBasicMaterial({ color: 0x000205 });
        const skyMask = new THREE.Mesh(skyMaskGeo, skyMaskMat);
        skyMask.position.set(0, 35, -20); 
        skyMask.lookAt(0, 0, 0);
        scene.add(skyMask);

        // This group acts as the main spinning drum
        const timelineRig = new THREE.Group();
        timelineRig.position.y = worldSettings.wheelRadius - 8; 
        scene.add(timelineRig);

        function buildRoadway() {
            const cylinderGeo = new THREE.CylinderGeometry(
                worldSettings.wheelRadius, 
                worldSettings.wheelRadius, 
                worldSettings.roadWidth, 
                64, 1, true
            );
            
            const roadCanvas = document.createElement('canvas');
            roadCanvas.width = 1024; roadCanvas.height = 1024;
            const context = roadCanvas.getContext('2d');
            
            // Dark base
            context.fillStyle = '#000508';
            context.fillRect(0,0,1024,1024);

            // Neon Grid lines
            context.strokeStyle = '#00ffff'; 
            context.lineWidth = 2; 
            
            for(let i=0; i<=6; i++) {
                let x = (1024/6) * i;
                context.beginPath(); context.moveTo(x,0); context.lineTo(x,1024); context.stroke();
            }

            context.strokeStyle = 'rgba(0, 255, 255, 0.15)';
            for(let i=0; i<32; i++) {
                let y = (1024/32) * i;
                context.beginPath(); context.moveTo(0,y); context.lineTo(1024,y); context.stroke();
            }

            // Glowing Edges
            context.fillStyle = '#00ffff';
            context.fillRect(0,0, 15, 1024);
            context.fillRect(1009,0, 15, 1024);

            const roadTexture = new THREE.CanvasTexture(roadCanvas);
            roadTexture.wrapS = THREE.RepeatWrapping;
            roadTexture.wrapT = THREE.RepeatWrapping;
            roadTexture.repeat.set(1, 24); 
            roadTexture.anisotropy = 16;

            const roadMaterial = new THREE.MeshBasicMaterial({
                map: roadTexture,
                color: 0xffffff, 
                side: THREE.BackSide,
                transparent: true,
                opacity: 0.9
            });

            const roadMesh = new THREE.Mesh(cylinderGeo, roadMaterial);
            roadMesh.rotation.z = Math.PI / 2; 
            timelineRig.add(roadMesh);
        }
        
        buildRoadway();

        // Setup the card objects
        const milestoneCards = [];
        const boxGeometry = new THREE.BoxGeometry(22, 11, 0.5); 

        function generateCardTexture(text, date) {
            const cvs = document.createElement('canvas');
            cvs.width = 1024; cvs.height = 512; 
            const ctx = cvs.getContext('2d');

            // Card Background
            ctx.fillStyle = 'rgba(0,10,20,0.95)';
            ctx.fillRect(0,0,1024,512);

            // Neon Border
            ctx.strokeStyle = cardAppearance.borderColor;
            ctx.lineWidth = 15;
            ctx.strokeRect(10,10,1004,492);
            
            ctx.textAlign = 'center';

            // Title logic (shrink font if name is huge)
            if (text.length > 15) {
                 ctx.font = cardAppearance.titleFontLong;
            } else {
                 ctx.font = cardAppearance.titleFont;
            }
            
            ctx.fillStyle = cardAppearance.titleColor; 
            ctx.fillText(text.toUpperCase(), 512, cardAppearance.titleY);

            // Date text
            ctx.font = cardAppearance.dateFont;
            ctx.fillStyle = cardAppearance.dateColor;
            ctx.fillText(`[ ${date} ]`, 512, cardAppearance.dateY);

            return new THREE.CanvasTexture(cvs);
        }

        timelineEvents.forEach((event, i) => {
            const angle = i * anglePerCard;

            const material = new THREE.MeshBasicMaterial({
                map: generateCardTexture(event.name, event.date),
            });

            const mesh = new THREE.Mesh(boxGeometry, material);
            const pivotGroup = new THREE.Group();
            timelineRig.add(pivotGroup);
            
            pivotGroup.rotation.x = -angle;

            const r = worldSettings.wheelRadius; 
            
            // Stagger cards left/right unless it's a section header
            let xOffset = 0;
            let yRotation = 0;

            if (event.isCenter) {
                xOffset = 0; 
                yRotation = 0;    
            } else {
                const isLeft = i % 2 !== 0; 
                xOffset = isLeft ? -16 : 16; 
                yRotation = isLeft ? 0.45 : -0.45;
            }
            
            mesh.position.set(xOffset, -r + 9, 0); 
            mesh.rotation.x = -Math.PI / 2 + 1.35; 
            mesh.rotation.y = yRotation;

            pivotGroup.add(mesh);
            milestoneCards.push({ pivot: pivotGroup, angle, date: event.date.split('–')[0] });
        });

        // Post-processing for that neon glow
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.1; 
        bloomPass.strength = 1.3; 
        bloomPass.radius = 0.5;
        composer.addPass(bloomPass);

        // Handle scrolling
        window.addEventListener('wheel', (e) => {
            viewerState.targetScroll -= e.deltaY * worldSettings.scrollSpeed;
        });

        // UI Element References
        const uiPanel = document.getElementById('info-panel');
        const uiName = document.getElementById('ui-name');
        const uiMeta = document.getElementById('ui-meta');
        const uiDesc = document.getElementById('ui-desc');
        const dateDisplay = document.getElementById('date-display');
        const progressFill = document.getElementById('progress-line-fill');
        const loadingScreen = document.getElementById('loading');

        function updateInfoPanel(index) {
            if (viewerState.activeCardIndex === index) return;
            viewerState.activeCardIndex = index;
            uiPanel.classList.remove('active');

            // If no card is focused, show general status
            if (index === -1) {
                if (viewerState.currentScroll > viewerState.maxScroll - 0.2) {
                    dateDisplay.innerText = "2022";
                } else if (viewerState.currentScroll < 0.2) {
                    dateDisplay.innerText = "FIN";
                } else {
                    dateDisplay.innerText = "---";
                }
                return;
            }

            const data = timelineEvents[index];
            dateDisplay.innerText = data.date.split('–')[0];
            
            // Short delay for transition effect
            setTimeout(() => {
                uiName.innerText = data.name;
                uiMeta.innerText = `${data.date}`;
                uiDesc.innerText = data.desc;
                uiPanel.classList.add('active');
            }, 100);
        }

        function gameLoop() {
            requestAnimationFrame(gameLoop);

            // Handle initial load animation
            if (!viewerState.isLoaded) {
                viewerState.isLoaded = true;
                loadingScreen.style.opacity = '0';
                setTimeout(() => loadingScreen.style.display = 'none', 1000);
            }

            // Clamp scroll to start/end
            viewerState.targetScroll = Math.max(0.0, Math.min(viewerState.maxScroll + 1.0, viewerState.targetScroll));
            
            // Smooth scroll physics
            viewerState.currentScroll += (viewerState.targetScroll - viewerState.currentScroll) * 0.08;

            timelineRig.rotation.x = viewerState.currentScroll;

            // Update bottom progress bar
            let progress = 1 - (viewerState.currentScroll / viewerState.maxScroll);
            progress = Math.max(0, Math.min(1, progress));
            progressFill.style.width = (progress * 100) + '%';

            // Check which card is closest to the viewer
            let closestDistance = Infinity;
            let closestIndex = -1;

            milestoneCards.forEach((card, i) => {
                const distanceToCenter = Math.abs(viewerState.currentScroll - card.angle - 0.2);
                
                // Optimization: Hide cards that are far away
                if (distanceToCenter > 2.5) {
                    card.pivot.visible = false;
                } else {
                    card.pivot.visible = true;
                }

                if (distanceToCenter < closestDistance) {
                    closestDistance = distanceToCenter;
                    closestIndex = i;
                }
            });

            // Trigger UI update if a card is "locked in"
            if (closestDistance < 1.1 && milestoneCards[closestIndex].pivot.visible) {
                updateInfoPanel(closestIndex);
            } else if (closestDistance > 1.2 && viewerState.activeCardIndex !== -1) {
                // Clear UI if we are between cards
                viewerState.activeCardIndex = -1;
                uiPanel.classList.remove('active');
            }

            composer.render();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

        gameLoop();

    </script>
</body>
</html>
